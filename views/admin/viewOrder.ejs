<%- include('../../partials/userHeader') %>

<head>
    <style>
        .gradient-custom {
            background: #f6d365;
            background: -webkit-linear-gradient(to right bottom, rgba(246, 211, 101, 1), rgba(253, 160, 133, 1));
            background: linear-gradient(to right bottom, rgba(246, 211, 101, 1), rgba(253, 160, 133, 1))
        }

        h6 {
            margin-top: 50px;
        }
    </style>
</head>

<div class="bg-primary bg-gradient shadow-lg">
    <div class="container py-4">
        <!-- Breadcrumb -->
        <nav class="d-flex">
            <h5 class="mb-0">
                <a href="/" class="text-white">Home</a>
                <span class="text-white-50 mx-2"> > </span>
                <a href="/user/profile" class="text-white">Account</a>
                <span class="text-white-50 mx-2"> > </span>
                <a href="/user/orders" class="text-white">My Orders</a>
            </h5>
        </nav>
        <!-- Breadcrumb -->
    </div>
</div>

<section class="pt-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 px-3">
                <div class="account-nav rounded shadow bg-white p-4">
                    <div class="text-center mb-4">
                        <h4 class="mb-0">Hi <%= user.name %></h4>
                        <p class="text-muted">Your personal dashboard</p>
                    </div>
                    <div class="text-center my-3">
                        <a class="nav-link" href="/user/viewCart">
                            <i class="fa-solid fa-wallet me-1"></i>Wallet Amount: <%= user.wallet.toFixed(2) %>
                        </a>
                    </div>
                    <hr>
                    <button class="btn btn-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#navCollapse" aria-expanded="false" aria-controls="navCollapse">
                        Menu
                    </button>
                    <div class="collapse mt-3" id="navCollapse">
                        <ul class="list-unstyled mb-0">
                            <li>
                                <a href="/user/profile" class="text-decoration-none text-primary d-block py-2">
                                    <button class="btn btn-secondary w-100">Profile</button>
                                </a>
                            </li>
                            <li>
                                <a href="/user/address" class="text-decoration-none text-dark d-block py-2">
                                    <button class="btn btn-secondary w-100">Address</button>
                                </a>
                            </li>
                            <li>
                                <a href="/user/orders" class="text-decoration-none text-dark d-block py-2">
                                    <button class="btn btn-primary w-100">My Orders</button>
                                </a>
                            </li>
                            <li>
                                <a href="/user/viewWishlist" class="text-decoration-none text-dark d-block py-2">
                                    <button class="btn btn-secondary w-100">My Wishlist</button>
                                </a>
                            </li>
                            <li>
                                <a href="/user/wallethistory" class="text-decoration-none text-dark d-block py-2">
                                    <button class="btn btn-secondary w-100">Wallet History</button>
                                </a>
                            </li>
                            <li>
                                <a href="/user/forgot" class="text-decoration-none text-dark d-block py-2">
                                    <button class="btn btn-secondary w-100">Change Password</button>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-lg-9 px-3 justify-content-center d-flex">
                <div class="col-md-9 checkout">
                    <div class="container">
                        <div class="d-flex justify-content-between">
                            <h4>Order History</h4>
                        </div>

                        <div class="row">
                            <div class="col-lg-12">
                                <nav>
                                    <div class="nav nav-tabs mb-3">
                                        <!-- <button class="nav-link active border-white border-bottom-0" type="button"
                                        role="tab" id="nav-placed-tab" data-bs-toggle="tab"
                                        data-bs-target="#nav-placed" aria-controls="nav-placed"
                                        aria-selected="true">Order Placed</button> -->
                                    </div>
                                </nav>
                                <div class="tab-content mb-5">
                                    <div class="tab-pane active ms-4" id="nav-returned" role="tabpanel"
                                        aria-labelledby="nav-returned-tab">
                                        <% if(!order) { %>
                                            <div class="d-flex justify-content-center my-5 border">
                                                <h3>No orders yet</h3>
                                            </div>
                                        <% } else { %>
                                            <div class="col-md-12 mb-3">
                                                <div class="card shadow">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <h5 class="card-title text-muted m-2">Order <%= order._id %></h5>
                                                        <% if(order.status == "Pending" && order.paymentStatus == "Completed") { %>
                                                            <p class="text-warning m-0 border-left border-secondary p-2">Status : Order Placed</p>
                                                            <button class="btn btn-warning cancelButton" id="pendingOrderId" data-orderId="<%= order._id %>">Cancel</button>
                                                        <% } else if(order.status == "Cancelled") { %>
                                                            <p class="text-danger border-left border-danger m-0 p-2">Status : Cancelled</p>
                                                        <% } else if(order.status == "Pending" && order.paymentStatus == "Failed") { %>
                                                            <p class="text-warning m-0 border-left border-secondary p-2">Status : Payment Pending</p>
                                                            <button class="btn btn-success" id="retryPayment" data-orderId="<%= order._id %>" data-amount="<%= order.totalAmount %>">Retry Payment</button>
                                                            <button class="btn btn-warning cancelButton" id="pendingOrderId" data-orderId="<%= order._id %>">Cancel</button>
                                                        <% } else if(order.status == "Delivered") { %>
                                                            <p class="text-success m-0">Status : Delivered</p>
                                                            <a href="/user/invoice/<%= order._id %>">
                                                                <button class="btn btn-success deliveredOrderId">Download Invoice</button>
                                                            </a>
                                                            <!-- Add the Return Button Here -->
                                                            <button class="btn btn-danger returnButton" data-orderId="<%= order._id %>">Return Order</button>
                                                        <% } %>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="d-flex">
                                                            <span class="m-1 font-weight-bold">Order Date: <%= new Date(order.orderedDate).toDateString() %></span>
                                                        </div>
                                                        <div class="d-flex">
                                                            <span class="m-1 font-weight-bold">Total Items: <%= order.orderedItems.length %></span>
                                                        </div>
                                                        <% order.orderedItems.forEach((product, j) => { %>
                                                            <div class="border-left border-5 border-secondary my-3 p-3">
                                                                <div class="row">
                                                                    <div class="col-8">
                                                                        <h5 class="justify-content-center d-flex">Product <%= j + 1 %></h5>
                                                                        <% if (product.productId) { %>
                                                                            <p>Product Name: <%= product.pname %></p>
                                                                            <p>Product quantity: <%= product.quantity %></p>
                                                                            <p>Product price: <%= product.price %></p>
                                                                        <% } else { %>
                                                                            <p class="text-danger">This product does not exist anymore</p>
                                                                        <% } %>
                                                                    </div>
                                                                    <div class="col-4">
                                                                        <% if (product.pimages && product.pimages.length > 0) { %>
                                                                            <img class="rounded-2 w-100" src="/uploads/images-1735886535605-69034412.webp" />
                                                                        <% } else { %>
                                                                            <p class="text-muted">No image available</p>
                                                                        <% } %>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        <% }) %>
                                                        <div class="d-flex">
                                                            <span class="m-1 font-weight-bold">Payment Method: <%= order.paymentMethod %></span>
                                                        </div>
                                                        <div class="d-flex">
                                                            <span class="m-1 font-weight-bold">Total Amount: <%= order.totalAmount %></span>
                                                        </div>
                                                        <% if (order.couponApplied && order.couponApplied.code) { %>
                                                            <div class="d-flex">
                                                                <span class="m-1 font-weight-bold">Coupon Applied: <%= order.couponApplied.code %></span>
                                                                <span class="m-1 text-muted">Discount: <%= order.couponApplied.discount %>%</span>
                                                            </div>
                                                        <% } else { %>
                                                            <div class="d-flex">
                                                                <span class="m-1 font-weight-bold">No coupon applied</span>
                                                            </div>
                                                        <% } %>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://js.stripe.com/v3/"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>



    document.addEventListener('DOMContentLoaded', function () {
        const returnButtons = document.querySelectorAll('.returnButton');

        returnButtons.forEach(button => {
            button.addEventListener('click', function () {
                const orderId = this.getAttribute('data-orderId');

                Swal.fire({
                    title: 'Are you sure?',
                    text: 'Do you want to return this order?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, return it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/user/returnOrder/${orderId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            
                            },
                            credentials:"include",
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Success!', 'Order has been returned and refunded.', 'success').then(() => {
                                    location.reload(); // Reload the page to reflect changes
                                });
                            } else {
                                Swal.fire('Error!', data.message, 'error');
                            }
                        })
                        .catch(error => {
                            Swal.fire('Error!', 'Something went wrong.', 'error');
                        });
                    }
                });
            });
        });
    });


</script>
